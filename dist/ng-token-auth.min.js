"undefined"!=typeof module&&"undefined"!=typeof exports&&module.exports===exports&&(module.exports="ng-token-auth"),angular.module("ng-token-auth",["ipCookie"]).provider("$auth",function(){var e,t;return e={"default":{apiUrl:"/api",signOutUrl:"/auth/sign_out",emailSignInPath:"/auth/sign_in",emailRegistrationPath:"/auth",accountUpdatePath:"/auth",accountDeletePath:"/auth",confirmationSuccessUrl:function(){return window.location.href},passwordResetPath:"/auth/password",passwordUpdatePath:"/auth/password",passwordResetSuccessUrl:function(){return window.location.href},tokenValidationPath:"/auth/validate_token",proxyIf:function(){return!1},proxyUrl:"/proxy",validateOnPageLoad:!0,omniauthWindowType:"sameWindow",storage:"cookies",forceValidateToken:!1,tokenFormat:{"access-token":"{{ token }}","token-type":"Bearer",client:"{{ clientId }}",expiry:"{{ expiry }}",uid:"{{ uid }}"},cookieOps:{path:"/",expires:9999,expirationUnit:"days",secure:!1},createPopup:function(e){return window.open(e,"_blank","closebuttoncaption=Cancel")},parseExpiry:function(e){return 1e3*parseInt(e.expiry,10)||null},handleLoginResponse:function(e){return e.data},handleAccountUpdateResponse:function(e){return e.data},handleTokenValidationResponse:function(e){return e.data},authProviderPaths:{github:"/auth/github",facebook:"/auth/facebook",google:"/auth/google_oauth2"}}},t="default",{configure:function(n){var r,i,s,o,a,u,c,h,d;if(n instanceof Array&&n.length){for(o=h=0,d=n.length;h<d;o=++h){r=n[o],u=null;for(a in r)c=r[a],u=a,0===o&&(t=u);i=angular.copy(e["default"]),s={},s[u]=angular.extend(i,r[u]),angular.extend(e,s)}"default"!==t&&delete e["default"]}else{if(!(n instanceof Object))throw"Invalid argument: ng-token-auth config should be an Array or Object.";angular.extend(e["default"],n)}return e},$get:["$http","$q","$location","ipCookie","$window","$timeout","$rootScope","$interpolate","$interval",function(n){return function(r,i,s,o,a,u,c,h,d){return{header:null,dfd:null,user:{},mustResetPassword:!1,listener:null,initialize:function(){return this.initializeListeners(),this.cancelOmniauthInAppBrowserListeners=function(){},this.addScopeMethods()},initializeListeners:function(){if(this.listener=angular.bind(this,this.handlePostMessage),a.addEventListener)return a.addEventListener("message",this.listener,!1)},cancel:function(e){return null!=this.requestCredentialsPollingTimer&&u.cancel(this.requestCredentialsPollingTimer),this.cancelOmniauthInAppBrowserListeners(),null!=this.dfd&&this.rejectDfd(e),u(function(e){return function(){return e.requestCredentialsPollingTimer=null}}(this),0)},destroy:function(){if(this.cancel(),a.removeEventListener)return a.removeEventListener("message",this.listener,!1)},handlePostMessage:function(e){var t,n;if("deliverCredentials"===e.data.message&&(delete e.data.message,n=e.data.oauth_registration,delete e.data.oauth_registration,this.handleValidAuth(e.data,!0).then(function(){return c.$broadcast("auth:login-success",e.data)}),n&&c.$broadcast("auth:oauth-registration",e.data)),"authFailure"===e.data.message)return t={reason:"unauthorized",errors:[e.data.error]},this.cancel(t),c.$broadcast("auth:login-error",t)},addScopeMethods:function(){if(c.user=this.user,c.authenticate=angular.bind(this,this.authenticate),c.signOut=angular.bind(this,this.signOut),c.destroyAccount=angular.bind(this,this.destroyAccount),c.submitRegistration=angular.bind(this,this.submitRegistration),c.submitLogin=angular.bind(this,this.submitLogin),c.requestPasswordReset=angular.bind(this,this.requestPasswordReset),c.updatePassword=angular.bind(this,this.updatePassword),c.updateAccount=angular.bind(this,this.updateAccount),this.getConfig().validateOnPageLoad)return this.validateUser({config:this.getSavedConfig()})},submitRegistration:function(e,t){var n;return null==t&&(t={}),n=this.getResultOrValue(this.getConfig(t.config).confirmationSuccessUrl),angular.extend(e,{confirm_success_url:n,config_name:this.getCurrentConfigName(t.config)}),r.post(this.apiUrl(t.config)+this.getConfig(t.config).emailRegistrationPath,e).success(function(t){return c.$broadcast("auth:registration-email-success",e)}).error(function(e){return c.$broadcast("auth:registration-email-error",e)})},submitLogin:function(e,t,n){return null==t&&(t={}),null==n&&(n={}),this.initDfd(),r.post(this.apiUrl(t.config)+this.getConfig(t.config).emailSignInPath,e,n).success(function(e){return function(n){var r,i;return e.setConfigName(t.config),r=e.getConfig(t.config).handleLoginResponse(n,e),i=e,e.handleValidAuth(r).then(function(){return c.$broadcast("auth:login-success",i.user)})}}(this)).error(function(e){return function(t){return e.rejectDfd({reason:"unauthorized",errors:["Invalid credentials"]}),c.$broadcast("auth:login-error",t)}}(this)),this.dfd.promise},userIsAuthenticated:function(){var e,t;return e=i.defer(),t=this,this.retrieveData("auth_headers").then(function(n){var r;return r=n&&t.user.signedIn&&!t.tokenHasExpired(),e.resolve(r)}),e.promise},requestPasswordReset:function(e,t){var n;return null==t&&(t={}),n=this.getResultOrValue(this.getConfig(t.config).passwordResetSuccessUrl),e.redirect_url=n,null!=t.config&&(e.config_name=t.config),r.post(this.apiUrl(t.config)+this.getConfig(t.config).passwordResetPath,e).success(function(t){return c.$broadcast("auth:password-reset-request-success",e)}).error(function(e){return c.$broadcast("auth:password-reset-request-error",e)})},updatePassword:function(e){return r.put(this.apiUrl()+this.getConfig().passwordUpdatePath,e).success(function(e){return function(t){return c.$broadcast("auth:password-change-success",t),e.mustResetPassword=!1}}(this)).error(function(e){return c.$broadcast("auth:password-change-error",e)})},updateAccount:function(e){return r.put(this.apiUrl()+this.getConfig().accountUpdatePath,e).success(function(e){return function(t){var n,r,i,s,o,a;if(s=e.getConfig().handleAccountUpdateResponse(t),n=e.retrieveData("auth_headers"),angular.extend(e.user,s),n){i={},a=e.getConfig().tokenFormat;for(r in a)o=a[r],n[r]&&s[r]&&(i[r]=s[r]);e.setAuthHeaders(i)}return c.$broadcast("auth:account-update-success",t)}}(this)).error(function(e){return c.$broadcast("auth:account-update-error",e)})},destroyAccount:function(e){return r["delete"](this.apiUrl()+this.getConfig().accountUpdatePath,e).success(function(e){return function(t){return e.invalidateTokens(),c.$broadcast("auth:account-destroy-success",t)}}(this)).error(function(e){return c.$broadcast("auth:account-destroy-error",e)})},authenticate:function(e,t){return null==t&&(t={}),null==this.dfd&&(this.setConfigName(t.config),this.initDfd(),this.openAuthWindow(e,t)),this.dfd.promise},setConfigName:function(e){return null==e&&(e=t),this.persistData("currentConfigName",e,e)},openAuthWindow:function(e,t){var n,r;if(r=this.getConfig(t.config).omniauthWindowType,n=this.buildAuthUrl(r,e,t),"newWindow"===r)return this.requestCredentialsViaPostMessage(this.getConfig().createPopup(n));if("inAppBrowser"===r)return this.requestCredentialsViaExecuteScript(this.getConfig().createPopup(n));if("sameWindow"===r)return this.visitUrl(n);throw'Unsupported omniauthWindowType "#{omniauthWindowType}"'},visitUrl:function(e){return a.location.replace(e)},buildAuthUrl:function(e,t,n){var r,i,s,o;null==n&&(n={}),r=this.getConfig(n.config).apiUrl,r+=this.getConfig(n.config).authProviderPaths[t],r+="?auth_origin_url="+encodeURIComponent(a.location.href),s=angular.extend({},n.params||{},{omniauth_window_type:e});for(i in s)o=s[i],r+="&",r+=encodeURIComponent(i),r+="=",r+=encodeURIComponent(o);return r},requestCredentialsViaPostMessage:function(e){return e.closed?this.handleAuthWindowClose(e):(e.postMessage("requestCredentials","*"),this.requestCredentialsPollingTimer=u(function(t){return function(){return t.requestCredentialsViaPostMessage(e)}}(this),500))},requestCredentialsViaExecuteScript:function(e){var t,n;return this.cancelOmniauthInAppBrowserListeners(),t=this.handleAuthWindowClose.bind(this,e),n=this.handleLoadStop.bind(this,e),e.addEventListener("loadstop",n),e.addEventListener("exit",t),this.cancelOmniauthInAppBrowserListeners=function(){return e.removeEventListener("loadstop",n),e.removeEventListener("exit",t)}},handleLoadStop:function(e){return n=this,e.executeScript({code:"requestCredentials()"},function(t){var r,i;if(r=t[0])return i=new Event("message"),i.data=r,n.cancelOmniauthInAppBrowserListeners(),a.dispatchEvent(i),n.initDfd(),e.close()})},handleAuthWindowClose:function(e){return this.cancel({reason:"unauthorized",errors:["User canceled login"]}),this.cancelOmniauthInAppBrowserListeners,c.$broadcast("auth:window-closed")},resolveDfd:function(){return this.dfd.resolve(this.user),u(function(e){return function(){if(e.dfd=null,!c.$$phase)return c.$digest()}}(this),0)},buildQueryString:function(e,t){var n,r,i,s;i=[];for(r in e)s=e[r],r=t?t+"["+r+"]":r,n=angular.isObject(s)?this.buildQueryString(s,r):r+"="+encodeURIComponent(s),i.push(n);return i.join("&")},parseLocation:function(e){var t,n,r,i,s;if(n=e.substring(1),r={},n){s=n.split("&"),i=void 0,t=void 0;for(t in s)t=t,""!==s[t]&&"function"!=typeof s[t]&&(i=s[t].split("="),r[decodeURIComponent(i[0])]=decodeURIComponent(i[1]))}return r},validateUser:function(e){var t,n;return null==e&&(e={}),t=e.config,null==this.dfd&&(this.initDfd(),n=this,this.userIsAuthenticated().then(function(e){var r,i,o,a,u,h,d,l;return e?this.resolveDfd():(u=s.search(),o=n.parseLocation(window.location.search),a=0===Object.keys(u).length?o:u,h=a.auth_token||a.token,void 0!==h?(r=a.client_id,d=a.uid,i=a.expiry,t=a.config,n.setConfigName(t),n.mustResetPassword=a.reset_password,n.firstTimeLogin=a.account_confirmation_success,n.oauthRegistration=a.oauth_registration,n.setAuthHeaders(n.buildAuthHeaders({token:h,clientId:r,uid:d,expiry:i})),l=s.path()||"/",["auth_token","token","client_id","uid","expiry","config","reset_password","account_confirmation_success","oauth_registration"].forEach(function(e){return delete a[e]}),Object.keys(a).length>0&&(l+="?"+n.buildQueryString(a)),s.url(l)):n.retrieveData("currentConfigName").then(function(e){if(e)return t=e}),n.getConfig().forceValidateToken?n.validateToken({config:t}):n.retrieveData("auth_headers").then(function(e){return isEmpty(e)?(n.rejectDfd({reason:"unauthorized",errors:["No credentials"]}),c.$broadcast("auth:invalid")):n.tokenHasExpired()?(c.$broadcast("auth:session-expired"),n.rejectDfd({reason:"unauthorized",errors:["Session expired."]})):n.validateToken({config:t})}))})),this.dfd.promise},validateToken:function(e){return null==e&&(e={}),this.tokenHasExpired()?this.rejectDfd({reason:"unauthorized",errors:["Expired credentials"]}):r.get(this.apiUrl(e.config)+this.getConfig(e.config).tokenValidationPath).success(function(t){return function(n){var r;return r=t.getConfig(e.config).handleTokenValidationResponse(n),t.handleValidAuth(r).then(function(){return this.firstTimeLogin&&c.$broadcast("auth:email-confirmation-success",this.user),this.oauthRegistration&&c.$broadcast("auth:oauth-registration",this.user),this.mustResetPassword&&c.$broadcast("auth:password-reset-confirm-success",this.user),c.$broadcast("auth:validation-success",this.user)})}}(this)).error(function(e){return function(t){return e.firstTimeLogin&&c.$broadcast("auth:email-confirmation-error",t),e.mustResetPassword&&c.$broadcast("auth:password-reset-confirm-error",t),c.$broadcast("auth:validation-error",t),e.rejectDfd({reason:"unauthorized",errors:null!=t?t.errors:["Unspecified error"]})}}(this))},tokenHasExpired:function(){var e,t;return e=this.getExpiry(),t=(new Date).getTime(),e&&e<t},getExpiry:function(){return this.getConfig().parseExpiry(this.retrieveData("auth_headers")||{})},invalidateTokens:function(){var e,t,n,r,s;e=i.defer(),s=this.user;for(t in s)r=s[t],delete this.user[t];return n=this,this.deleteData("currentConfigName").then(function(){return null!=n.timer&&d.cancel(n.timer),n.deleteData("auth_headers").then(function(){return e.resolve()})}),e.promise},signOut:function(){return r["delete"](this.apiUrl()+this.getConfig().signOutUrl).success(function(e){return function(t){return e.invalidateTokens().then(function(){return c.$broadcast("auth:logout-success")})}}(this)).error(function(e){return function(t){return e.invalidateTokens().then(function(){return c.$broadcast("auth:logout-error",t)})}}(this))},handleValidAuth:function(e,t){var n;return null==t&&(t=!1),n=i.defer(),null!=this.requestCredentialsPollingTimer&&u.cancel(this.requestCredentialsPollingTimer),this.cancelOmniauthInAppBrowserListeners(),angular.extend(this.user,e),this.user.signedIn=!0,this.user.configName=this.getCurrentConfigName(),t?this.setAuthHeaders(this.buildAuthHeaders({token:this.user.auth_token,clientId:this.user.client_id,uid:this.user.uid,expiry:this.user.expiry})).then(function(){return n.resolve(),self.resolveDfd()}):(n.resolve(),this.resolveDfd()),n.promise},buildAuthHeaders:function(e){var t,n,r,i;t={},i=this.getConfig().tokenFormat;for(n in i)r=i[n],t[n]=h(r)(e);return t},persistData:function(e,t,n){var r;if(r=i.defer(),this.getConfig(n).storage instanceof Object)this.getConfig(n).storage.persistData(e,t,this.getConfig(n)).then(function(){return r.resolve()});else{switch(this.getConfig(n).storage){case"localStorage":a.localStorage.setItem(e,JSON.stringify(t));break;case"sessionStorage":a.sessionStorage.setItem(e,JSON.stringify(t));break;default:o(e,t,this.getConfig().cookieOps)}r.resolve()}return r.promise},retrieveData:function(e){var t,n;t=i.defer();try{if(this.getConfig().storage instanceof Object)this.getConfig().storage.retrieveData(e).then(function(e){return t.resolve(e)});else switch(this.getConfig().storage){case"localStorage":t.resolve(JSON.parse(a.localStorage.getItem(e)));break;case"sessionStorage":t.resolve(JSON.parse(a.sessionStorage.getItem(e)));break;default:t.resolve(o(e))}}catch(r){if(n=r,!(n instanceof SyntaxError))throw n;t.resolve(void 0)}return t.promise},deleteData:function(e){var t;switch(t=i.defer(),this.getConfig().storage instanceof Object&&this.getConfig().storage.deleteData(e).then(function(){return t.resolve()}),this.getConfig().storage){case"localStorage":a.localStorage.removeItem(e);break;case"sessionStorage":a.sessionStorage.removeItem(e);break;default:o.remove(e,{path:this.getConfig().cookieOps.path})}return t.resolve(),t.promise},setAuthHeaders:function(e){var t,n;return t=i.defer(),n=this,this.retrieveData("auth_headers").then(function(r){var i;return i=angular.extend(r||{},e),n.persistData("auth_headers",i).then(function(e){var r,i;return r=n.getExpiry(),i=(new Date).getTime(),r>i&&(null!=n.timer&&d.cancel(n.timer),n.timer=d(function(e){return function(){return n.validateUser({config:n.getSavedConfig()})}}(this),parseInt(r-i),1)),t.resolve(e)})}),t.promise},initDfd:function(){return this.dfd=i.defer()},rejectDfd:function(e){if(this.invalidateTokens(),null!=this.dfd)return this.dfd.reject(e),u(function(e){return function(){return e.dfd=null}}(this),0)},apiUrl:function(e){return this.getConfig(e).proxyIf()?this.getConfig(e).proxyUrl:this.getConfig(e).apiUrl},getConfig:function(t){return e[this.getCurrentConfigName(t)]},getResultOrValue:function(e){return"function"==typeof e?e():e},getCurrentConfigName:function(e){return e||this.getSavedConfig()},getSavedConfig:function(){var e,n;return e=void 0,n="currentConfigName",this.hasLocalStorage()?null==e&&(e=JSON.parse(a.localStorage.getItem(n))):this.hasSessionStorage()&&null==e&&(e=JSON.parse(a.sessionStorage.getItem(n))),null==e&&(e=o(n)),e||t},hasSessionStorage:function(){var e;if(null==this._hasSessionStorage){this._hasSessionStorage=!1;try{a.sessionStorage.setItem("ng-token-auth-test","ng-token-auth-test"),a.sessionStorage.removeItem("ng-token-auth-test"),this._hasSessionStorage=!0}catch(t){e=t}}return this._hasSessionStorage},hasLocalStorage:function(){var e;if(null==this._hasLocalStorage){this._hasLocalStorage=!1;try{a.localStorage.setItem("ng-token-auth-test","ng-token-auth-test"),a.localStorage.removeItem("ng-token-auth-test"),this._hasLocalStorage=!0}catch(t){e=t}}return this._hasLocalStorage}}}}(this)]}}).config(["$httpProvider",function(e){var t,n,r;return n=function(e,t){var n,r;return r=Number(e.getExpiry()),n=Number(e.getConfig().parseExpiry(t||{})),n>=r},r=function(e,t){var r,i,s,o;i={},o=e.getConfig().tokenFormat;for(r in o)s=o[r],t.headers(r)&&(i[r]=t.headers(r));if(n(e,i))return e.setAuthHeaders(i)},e.interceptors.push(["$injector",function(e){return{request:function(t){var n;return n=t,e.invoke(["$http","$auth","$q",function(e,r,i){var s;if(t.url.match(r.apiUrl()))return s=i.defer(),r.retrieveData("auth_headers").then(function(e){var n,r;for(n in e)r=e[n],t.headers[n]=r;return s.resolve(t)}),n=s.promise}]),n},response:function(t){return e.invoke(["$http","$auth",function(e,n){if(t.config.url.match(n.apiUrl()))return r(n,t)}]),t},responseError:function(t){return e.invoke(["$http","$auth",function(e,n){if(t.config.url.match(n.apiUrl()))return r(n,t)}]),e.get("$q").reject(t)}}}]),t=["get","post","put","patch","delete"],angular.forEach(t,function(t){var n;return null==(n=e.defaults.headers)[t]&&(n[t]={}),e.defaults.headers[t]["If-Modified-Since"]="Mon, 26 Jul 1997 05:00:00 GMT"})}]).run(["$auth","$window","$rootScope",function(e,t,n){return e.initialize()}]),window.isOldIE=function(){var e,t,n;return t=!1,e=navigator.userAgent.toLowerCase(),e&&e.indexOf("msie")!==-1&&(n=parseInt(e.split("msie")[1]),n<10&&(t=!0)),t},window.isIE=function(){var e;return e=navigator.userAgent.toLowerCase(),e&&e.indexOf("msie")!==-1||!!navigator.userAgent.match(/Trident.*rv\:11\./)},window.isEmpty=function(e){var t,n;if(!e)return!0;if(e.length>0)return!1;if(0===e.length)return!0;for(t in e)if(n=e[t],Object.prototype.hasOwnProperty.call(e,t))return!1;return!0};